{% extends 'layout.html' %}

{% block title %}ì„œë¹„ìŠ¤ ì„ íƒ{% endblock %}

{% block content %}
<div class="w-full max-w-5xl mx-auto p-8">

    <div class="text-center mb-16">
        <h1 class="text-5xl font-extrabold mb-4 text-[var(--text-main)]">
            ë‹¹ì‹ ì˜ ì„±ê³µì ì¸ ì·¨ì—…ì„ ìœ„í•œ
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-indigo-500">
                ëª¨ë“  ì†”ë£¨ì…˜
            </span>
        </h1>
        <p class="text-[var(--text-secondary)] text-lg max-w-5xl mx-auto">
            ì±„ìš© ê³µê³  ìš”ì•½ë¶€í„° ê¸°ì—…ì •ë³´ ì¡°íšŒ, ìµœì‹  ë‰´ìŠ¤ì™€ ê°•ì˜ ê²€ìƒ‰, ê³µê³  ì•Œë¦¬ë¯¸ê¹Œì§€ <br/>
            ì·¨ì—… ì¤€ë¹„ì˜ ëª¨ë“  ê³¼ì •ì„ í•œ ê³³ì—ì„œ í•´ê²°í•˜ì„¸ìš”.
        </p>
    </div>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="bg-[var(--bg-card)] border-l-4 border-indigo-500 text-[var(--text-main)] p-4 mb-6 rounded-lg shadow" role="alert">
        <p class="font-bold">ì•Œë¦¼</p><p>{{ messages[0] }}</p>
    </div>
    {% endif %}
    {% endwith %}

    <div class="grid md:grid-cols-2 gap-8">
        <div class="bg-[var(--bg-card)] p-8 rounded-2xl shadow-lg text-center flex flex-col justify-between">
            <div>
                <h3 class="text-2xl font-bold text-[var(--text-main)] mb-4">â­ ì±„ìš©ê³µê³  ìš”ì•½</h3>
                <p class="text-[var(--text-secondary)] mb-6">ì±„ìš© ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ê³  ìš”ì•½í•˜ì—¬ ëª¨ì•„ì¤ë‹ˆë‹¤.</p>
            </div>
            <a href="{{ url_for('crawler_page') }}" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">ì‹œì‘í•˜ê¸°</a>
        </div>

        <div class="bg-[var(--bg-card)] p-8 rounded-2xl shadow-lg text-center flex flex-col justify-between">
            <div>
                <h3 class="text-2xl font-bold text-[var(--text-main)] mb-4">ğŸ“ˆ ê¸°ì—… ì¬ë¬´ì •ë³´ ì¡°íšŒ</h3>
                <p class="text-[var(--text-secondary)] mb-6">ê¸°ì—…ëª…ìœ¼ë¡œ ìš”ì•½ ì¬ë¬´ì œí‘œë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
            </div>
            <a href="{{ url_for('finance_page') }}" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">ì‹œì‘í•˜ê¸°</a>
        </div>

        <div class="bg-[var(--bg-card)] p-8 rounded-2xl shadow-lg text-center flex flex-col justify-between">
            <div>
                <h3 class="text-2xl font-bold text-[var(--text-main)] mb-4">ğŸ“š ì¸í”„ëŸ° ê°•ì˜ ê²€ìƒ‰</h3>
                <p class="text-[var(--text-secondary)] mb-6">ë“£ê³  ì‹¶ì€ ê°•ì˜ë¥¼ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
            </div>
            <a href="{{ url_for('inflearn_page') }}" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">ê²€ìƒ‰í•˜ê¸°</a>
        </div>

        <div class="bg-[var(--bg-card)] p-8 rounded-2xl shadow-lg text-center flex flex-col justify-between">
            <div>
                <h3 class="text-2xl font-bold text-[var(--text-main)] mb-4">ğŸ“° ë‰´ìŠ¤ ê²€ìƒ‰</h3>
                <p class="text-[var(--text-secondary)] mb-6">í‚¤ì›Œë“œë¡œ ìµœì‹  ë‰´ìŠ¤ë¥¼ ë°”ë¡œ í™•ì¸í•©ë‹ˆë‹¤.</p>
            </div>
            <a href="{{ url_for('news_page') }}" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">ê²€ìƒ‰í•˜ê¸°</a>
        </div>
    </div>

    <div class="mt-8 bg-[var(--bg-card)] p-8 rounded-2xl shadow-lg">
        <h3 class="text-2xl font-bold text-[var(--text-main)] mb-2 text-center">ğŸ“¢ ì±„ìš© ê³µê³  ìë™ ì•Œë¦¼</h3>
        <p class="text-[var(--text-secondary)] mb-6 text-center">ì›í•˜ëŠ” ì¡°ê±´ì˜ ì±„ìš© ê³µê³ ë¥¼ ë§¤ì¼ ì•„ì¹¨ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë°›ì•„ë³´ì„¸ìš”.</p>

        <form id="alarmForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="keyword" class="block text-sm font-normal text-[var(--text-secondary)]">í‚¤ì›Œë“œ</label>
                    <input
                        type="text" id="keyword" name="keyword" placeholder="ì˜ˆ: python, verilog, JavaScript"
                        class="mt-1 block w-full px-3 py-2 bg-[var(--bg-input)] border border-[var(--border-input)] text-[var(--text-main)] rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="count" class="block text-sm font-normal text-[var(--text-secondary)]">ê²€ìƒ‰ ê°œìˆ˜</label>
                    <input
                        type="number" id="count" name="count" min="1" step="1" placeholder="ì˜ˆ: 30"
                        class="mt-1 block w-full px-3 py-2 bg-[var(--bg-input)] border border-[var(--border-input)] text-[var(--text-main)] rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="send_time" class="block text-sm font-normal text-[var(--text-secondary)]">ì „ì†¡ ì‹œê°„</label>
                    <input
                        type="time" id="send_time" name="send_time"
                        class="mt-1 block w-full px-3 py-2 bg-[var(--bg-input)] border border-[var(--border-input)] text-[var(--text-main)] rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                    <p class="text-xs text-[var(--text-secondary)] mt-1">ì˜ˆ: 09:00 (ì˜ˆì•½ ì „ì†¡ ì‹œ í•„ìˆ˜)</p>
                </div>
                <div>
                    <label for="max_dday" class="block text-sm font-normal text-[var(--text-secondary)]">ë§ˆê° D-ì´ë‚´</label>
                    <input
                        type="number" id="max_dday" name="max_dday" min="0" placeholder="ì˜ˆ: 7"
                        class="mt-1 block w-full px-3 py-2 bg-[var(--bg-input)] border border-[var(--border-input)] text-[var(--text-main)] rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="batch_size" class="block text-sm font-normal text-[var(--text-secondary)]">ì¹´ì¹´ì˜¤ ë¬¶ìŒ ì „ì†¡ ê°œìˆ˜</label>
                    <input
                        type="number" id="batch_size" name="batch_size" min="1" placeholder="4ê°œ ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”"
                        class="mt-1 block w-full px-3 py-2 bg-[var(--bg-input)] border border-[var(--border-input)] text-[var(--text-main)] rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
            </div>

            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-start">
                    <input id="only_fresher" name="only_fresher" type="checkbox" value="1"
                           class="h-4 w-4 text-indigo-600 bg-[var(--bg-nav)] border-[var(--border-color)] rounded focus:ring-indigo-500" checked
                           onclick="if (this.checked) { document.getElementById('edu_only').checked = false; }"/>
                    <label for="only_fresher" class="ml-3 text-sm font-normal text-[var(--text-secondary)]">ì‹ ì…/ê²½ë ¥ë¬´ê´€ ê³µê³ ë§Œ ë³´ê¸°</label>
                </div>

                <div class="flex items-start">
                    <input id="edu_only" name="edu_only" type="checkbox"
                           class="h-4 w-4 text-indigo-600 bg-[var(--bg-nav)] border-[var(--border-color)] rounded focus:ring-indigo-500"
                           onclick="if (this.checked) { document.getElementById('only_fresher').checked = false; }"/>
                    <label for="edu_only" class="ml-3 text-sm font-normal text-[var(--text-secondary)]">êµìœ¡/ì·¨ì—…ì—°ê³„ ê³µê³ ë§Œ ë³´ê¸°</label>
                </div>

                <div class="flex items-center space-x-4">
                    <span class="text-sm font-normal text-[var(--text-secondary)]">ì•Œë¦¼</span>
                    <label class="text-[var(--text-secondary)]">
                        <input type="radio" name="enabled" value="1"
                               class="h-4 w-4 text-indigo-600 bg-[var(--bg-nav)] border-[var(--border-color)] focus:ring-indigo-500" checked />
                        ì¼œê¸°
                    </label>
                    <label class="text-[var(--text-secondary)]">
                        <input type="radio" name="enabled" value="0"
                               class="h-4 w-4 text-indigo-600 bg-[var(--bg-nav)] border-[var(--border-color)] focus:ring-indigo-500" />
                        ë„ê¸°
                    </label>
                </div>
            </div>

            <p id="scheduleHint"
               class="text-sm text-[var(--text-secondary)] mt-2 {% if not next_run %}hidden{% endif %}">
                {% if next_run %}ë‹¤ìŒ ì˜ˆì•½ ì „ì†¡: {{ next_run }}{% endif %}
            </p>

            <div class="flex flex-col md:flex-row gap-4 pt-4">
                <button id="btn-save" type="button"
                        class="w-full bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-600 transition">
                    ì•Œë¦¼ ì„¤ì • ì €ì¥
                </button>

                <button id="btn-send-now" type="button"
                        class="w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition">
                    ì§€ê¸ˆ ì¦‰ì‹œ ë°›ì•„ë³´ê¸°
                </button>
            </div>
        </form>
    </div>
</div>

<div id="modal" class="fixed inset-0 bg-black/40 hidden z-50">
    <div class="min-h-screen w-full flex items-center justify-center p-4">
        <div class="bg-[var(--bg-card)] rounded-xl p-6 w-full max-w-md shadow-xl text-center">
            <div id="modalIcon" class="mx-auto mb-3">
                <svg class="animate-spin h-8 w-8 mx-auto text-indigo-400" viewBox="0 0 24 24" fill="none">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                </svg>
            </div>
            <h4 id="modalTitle" class="text-lg font-bold text-[var(--text-main)]">ì²˜ë¦¬ ì¤‘â€¦</h4>
            <p id="modalText" class="text-[var(--text-secondary)] mt-1">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            <div class="mt-4 hidden" id="modalButtons">
                <button id="modalClose" class="px-4 py-2 rounded-lg bg-[var(--bg-nav)] text-white hover:bg-[var(--nav-hover-bg)]">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden bg-[var(--bg-nav)] text-white text-sm px-4 py-2 rounded-lg shadow"></div>

<script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    // ëª¨ë‹¬/í† ìŠ¤íŠ¸
    const showModal = (title, text, spinning=true) => {
        $("#modalTitle").textContent = title || "";
        $("#modalText").textContent = text || "";
        $("#modalButtons").classList.add("hidden");
        $("#modal").classList.remove("hidden");
        $("#modalIcon").innerHTML = spinning
                ? `<svg class="animate-spin h-8 w-8 mx-auto text-indigo-400" viewBox="0 0 24 24" fill="none">
                       <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                       <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                   </svg>`
                : `<svg class="h-8 w-8 mx-auto text-green-600" viewBox="0 0 24 24" fill="currentColor">
                       <path d="M9 16.2l-3.5-3.5L4 14.2l5 5 11-11-1.5-1.5z"/></svg>`;
    };
    const finishModal = (title, text, ok=true) => {
        $("#modalTitle").textContent = title || (ok ? "ì™„ë£Œ" : "ì‹¤íŒ¨");
        $("#modalText").textContent = text || "";
        $("#modalButtons").classList.remove("hidden");
        $("#modalIcon").innerHTML = ok
                ? `<svg class="h-8 w-8 mx-auto text-green-600" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2l-3.5-3.5L4 14.2l5 5 11-11-1.5-1.5z"/></svg>`
                : `<svg class="h-8 w-8 mx-auto text-red-600" viewBox="0 0 24 24" fill="currentColor"><path d="M18 6L6 18M6 6l12 12"/></svg>`;
    };
    $("#modalClose").addEventListener("click", ()=> $("#modal").classList.add("hidden"));
    const toast = (msg) => { const el = $("#toast"); el.textContent = msg; el.classList.remove("hidden"); setTimeout(()=> el.classList.add("hidden"), 2200); };

    // ìœ íš¨ì„±
    function bump(el){ el.classList.add("ring-2","ring-red-500"); setTimeout(()=> el.classList.remove("ring-2","ring-red-500"), 1500); el.focus(); }
    function requireNotEmpty(el, label){ const v=(el.value||"").trim(); if(!v){ showModal("ì…ë ¥ í•„ìš”",`â€˜${label}â€™ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`,false); $("#modalButtons").classList.remove("hidden"); bump(el); return false;} return true; }
    function requirePositiveInt(el, label){ const v=(el.value||"").trim(); if(!v||isNaN(v)||parseInt(v)<=0){ showModal("ì…ë ¥ í•„ìš”",`â€˜${label}â€™ëŠ” 1 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`,false); $("#modalButtons").classList.remove("hidden"); bump(el); return false;} return true; }

    // ì˜ˆì•½ í‘œì‹œ
    function updateScheduleUI(state){
        const el = $("#scheduleHint");
        const enabled = !!state?.enabled;
        const nextRun = state?.next_run;
        if (enabled && nextRun){
            const daily = state?.send_time ? ` (ë§¤ì¼ ${state.send_time})` : "";
            el.textContent = `ë‹¤ìŒ ì˜ˆì•½ ì „ì†¡: ${nextRun}${daily}`;
            el.classList.remove("hidden");
        } else {
            el.textContent = "";
            el.classList.add("hidden");
        }
    }
    async function refreshScheduleFromServer(){
        try{
            const res = await fetch("{{ url_for('api_schedule_status') }}", {headers: {"X-Requested-With":"XMLHttpRequest"}});
            if(!res.ok) return;
            const data = await res.json();
            updateScheduleUI(data);
        }catch(_){}
    }
    document.addEventListener("DOMContentLoaded", refreshScheduleFromServer);
    $$("input[name='enabled']").forEach(r=>{
        r.addEventListener("change",(e)=>{ if(e.target.value==="0") updateScheduleUI({enabled:false}); else refreshScheduleFromServer(); });
    });

    // í¼ ê°’ ìˆ˜ì§‘
    function formValues(){
        const fd = new URLSearchParams();
        fd.set("keyword", ($("#keyword").value||"").trim());
        fd.set("count", ($("#count").value||"").trim());
        fd.set("send_time", ($("#send_time").value||"").trim());
        fd.set("max_dday", ($("#max_dday").value||"7").trim());
        fd.set("batch_size", ($("#batch_size").value||"").trim());

        // 'edu_only'ê°€ ì²´í¬ë˜ì—ˆìœ¼ë©´ 'only_fresher'ëŠ” ë¬´ì¡°ê±´ falseë¡œ ì„¤ì •
        const eduOnlyChecked = $("#edu_only").checked;
        fd.set("edu_mode", eduOnlyChecked ? "only" : "exclude");
        fd.set("only_fresher", eduOnlyChecked ? "0" : ($("#only_fresher").checked ? "1" : "0"));

        const en = document.querySelector("input[name='enabled']:checked");
        if (en) fd.set("enabled", en.value);
        return fd;
    }

    // ì¦‰ì‹œ ì „ì†¡
    $("#btn-send-now").addEventListener("click", async ()=>{
        if(!requireNotEmpty($("#keyword"),"í‚¤ì›Œë“œ")) return;
        if(!requirePositiveInt($("#count"),"ê²€ìƒ‰ ê°œìˆ˜")) return;
        if(!requirePositiveInt($("#max_dday"),"ë§ˆê° D-ì´ë‚´")) return;
        if(!requirePositiveInt($("#batch_size"),"ì¹´ì¹´ì˜¤ ë¬¶ìŒ ì „ì†¡ ê°œìˆ˜")) return;

        const body = formValues();
        body.set("ajax","1");
        showModal("ë³´ë‚´ëŠ” ì¤‘â€¦","ìµœì‹  ê³µê³ ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.",true);
        try{
            const res = await fetch("{{ url_for('send_kakao_now') }}", {
                method:"POST",
                headers:{ "X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
                body: body.toString()
            });
            const data = await res.json();
            if(res.ok && data.ok){ finishModal("ì „ì†¡ ì™„ë£Œ",`ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ${data.sent||0}ê±´ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`); toast("ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); }
            else { finishModal("ì „ì†¡ ì‹¤íŒ¨", data.reason||data.message||"ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", false); }
        }catch(e){ finishModal("ì „ì†¡ ì‹¤íŒ¨", e.message||"ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.", false); }
    });

    // ì˜ˆì•½ ì €ì¥
    $("#btn-save").addEventListener("click", async ()=>{
        if(!requireNotEmpty($("#keyword"),"í‚¤ì›Œë“œ")) return;
        if(!requirePositiveInt($("#count"),"ê²€ìƒ‰ ê°œìˆ˜")) return;
        if(!requireNotEmpty($("#send_time"),"ì „ì†¡ ì‹œê°„")) return;
        if(!requirePositiveInt($("#max_dday"),"ë§ˆê° D-ì´ë‚´")) return;
        if(!requirePositiveInt($("#batch_size"),"ì¹´ì¹´ì˜¤ ë¬¶ìŒ ì „ì†¡ ê°œìˆ˜")) return;

        const vals = formValues();
        const time = vals.get("send_time");
        showModal("ì €ì¥ ì¤‘â€¦",`ë§¤ì¼ ${time}ì— ì¹´ì¹´ì˜¤ ì•Œë¦¼ì„ ë³´ë‚´ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.`,true);
        try{
            const res = await fetch("{{ url_for('subscribe_kakao') }}", {
                method:"POST",
                headers:{ "X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
                body: vals.toString()
            });
            const data = await res.json();
            if(res.ok && data.ok){
                finishModal("ì„¤ì • ì™„ë£Œ", data.message || "ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                toast("ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆì–´ìš”.");
                updateScheduleUI({enabled: data?.pref?.enabled, next_run: data?.next_run, send_time: data?.pref?.send_time});
            }else{
                finishModal("ì„¤ì • ì‹¤íŒ¨", data.message || "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", false);
            }
        }catch(e){ finishModal("ì„¤ì • ì‹¤íŒ¨", e.message||"ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.", false); }
    });
</script>
{% endblock %}